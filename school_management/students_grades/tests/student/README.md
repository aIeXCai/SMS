README â€” students_grades tests (student)

Purpose
-------
This folder (tests/student) contains focused unit and integration tests for the `students_grades` app, specifically the Student-related tests (forms, import/export, views and small model behaviours that are student-facing).

Structure & Conventions
-----------------------
- test_models.py
  - Model-level unit tests: field validators, uniqueness constraints, model helper methods, and __str__ outputs.

- test_student_forms.py
  - Form-level unit tests: `StudentForm` validation, save behavior (including Class creation/association), edit behavior, and edge cases.
  - Tests are grouped by TestCase classes: Validation, Save, Edit, Edge Cases. Each TestCase focuses on a single responsibility to make running subsets easier.

- test_student_imports.py
  - Integration tests for import/export endpoints (student_batch_import, template download).
  - Uses in-memory Excel workbooks (openpyxl) and `SimpleUploadedFile` to simulate uploads.

- test_student_views.py
  - Integration tests for student CRUD and batch operations (add/edit/delete, batch promote/delete/graduate/update status).
  - Uses Django TestClient and asserts redirects / JSON responses / DB side-effects.

How to run tests
----------------
From repository root (workspace):

Run the whole students_grades test package:

    python3 manage.py test school_management.students_grades.tests -v 2

Run only student form tests:

    python3 manage.py test school_management.students_grades.tests.student.test_student_forms -v 2

Run a single TestCase class (example):

    python3 manage.py test school_management.students_grades.tests.student.test_student_forms.StudentFormValidationTests -v 2

Run a single test method (example):

    python3 manage.py test school_management.students_grades.tests.student.test_student_forms.StudentFormValidationTests.test_required_fields_trigger_validation_errors -v 2

Tips & Gotchas
--------------
- Uploaded files in tests must present a `.name` attribute and a content_type. Use Django's `SimpleUploadedFile('students.xlsx', buf.getvalue(), content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')` when posting Excel in tests.

- When testing DB-level uniqueness/IntegrityError, wrap creation in `transaction.atomic()` to avoid leaving the test transaction in a broken state.

- For AJAX endpoints, add the header `HTTP_X_REQUESTED_WITH='XMLHttpRequest'` when posting with TestClient to trigger JSON branches.

- Tests that depend on dates should prefer constructing explicit `datetime.date` objects in test data rather than relying on parsing, unless the test is specifically about date parsing.

- If a test manipulates background/async tasks (e.g. `update_all_rankings_async.delay`), patch/mock the task sender to assert it was called without actually enqueuing work.

Adding new tests
----------------
1. Follow the existing grouping: put form validation tests in `test_student_forms.py`'s Validation TestCase; DB-interaction tests that require saving should go in the Save TestCase / integration tests.
2. Prefer small, isolated tests: create necessary DB fixtures in the test or in `setUp()`; avoid cross-test dependencies.
3. Use helpers for repeated data creation (e.g. `make_student_data(**overrides)` in the test file) to reduce duplication.
4. Document each test with a short Purpose/Setup/Action/Assertions block (see existing files for examples).

Debugging failing tests
-----------------------
- Re-run failing tests with `-v 2` to get more informative output.
- For assertion failures show `form.errors` in assert messages (many tests already pass `msg=form.errors`).
- When encountering migration or schema-related issues locally, ensure you are running tests against a fresh test DB (Django's test runner handles this automatically).

Contact / Follow-ups
--------------------
If you'd like, I can:
- Split very large test modules into smaller files (e.g. move Edit/EdgeCase tests into separate files).
- Add CI-friendly test tags (e.g. markers to run fast unit tests first).
- Add a small Makefile or npm script to run groups of tests quickly.


---
Generated by automated test-refactor assistant. Adjust wording to your project's tone as desired.
