{% extends 'base.html' %}
{% load exam_filters %}
{% load score_filters %}

{% block title %}学生成绩管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .page-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 10px;
    }

    .page-header h1 {
        margin: 0;
        font-weight: 600;
    }

    .stats-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }

    .stats-card .card-body {
        padding: 1.5rem;
    }

    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .filter-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .filter-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        border-radius: 15px 15px 0 0;
        padding: 1rem 1.5rem;
    }

    .table-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .table {
        font-size: 0.85rem;
    }

    .table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        font-weight: 600;
        color: #495057;
        padding: 10px 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        text-align: center;
    }

    .table td {
        padding: 8px 6px;
        vertical-align: middle;
        border-color: #f1f3f4;
        font-size: 0.8rem;
        white-space: nowrap;
        text-align: center;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.25em 0.5em;
    }

    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
</style>
{% endblock %}

{% block content %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-chart-line me-3"></i>成绩管理</h1>
                <p class="mb-0 opacity-75">管理学生考试成绩，支持手动录入和批量导入</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="{% url 'score_add' %}" class="btn btn-light border me-2">
                    <i class="fas fa-plus me-2"></i>手动新增成绩
                </a>
                <button type="button" class="btn btn-light border" data-bs-toggle="modal" data-bs-target="#batchImportModal">
                    <i class="fas fa-file-import me-2"></i>批量导入
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- 筛选表单 -->
    <div class="card filter-card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>筛选成绩
            </h5>
        </div>
        <div class="card-body">
            <form method="get" action="{% url 'score_list' %}">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label for="student_id_filter" class="form-label">学号</label>
                        <input type="text" class="form-control" id="student_id_filter" name="student_id_filter" value="{{ selected_student_id_filter|default_if_none:'' }}">
                    </div>
                    <div class="col-md-2">
                        <label for="student_name_filter" class="form-label">学生姓名</label>
                        <input type="text" class="form-control" id="student_name_filter" name="student_name_filter" value="{{ selected_student_name_filter|default_if_none:'' }}">
                    </div>
                    <div class="col-md-2">
                        <label for="exam_filter" class="form-label">考试</label>
                        <select class="form-select" id="exam_filter" name="exam_filter">
                            <option value="">--- 所有考试 ---</option>
                            {% for exam in exams %}
                                <option value="{{ exam.pk }}" {% if selected_exam_filter|safe == exam.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ exam.academic_year }} {{ exam.name }} ({{ exam.get_grade_level_display }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="grade_filter" class="form-label">年级</label>
                        <select class="form-select" id="grade_filter" name="grade_filter">
                            <option value="">--- 所有年级 ---</option>
                            {% for grade_value, grade_label in grade_levels %}
                                <option value="{{ grade_value }}" {% if selected_grade_filter|safe == grade_value|stringformat:"s" %}selected{% endif %}>
                                    {{ grade_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="class_filter" class="form-label">班级</label>
                        <select class="form-select" id="class_filter" name="class_filter">
                            <option value="">--- 所有班级 ---</option>
                            {% for class_value, class_label in class_name_choices %}
                                <option value="{{ class_value }}" {% if selected_class_filter|safe == class_value %}selected{% endif %}>
                                    {{ class_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="subject_filter" class="form-label">科目</label>
                        <select class="form-select" id="subject_filter" name="subject_filter">
                            <option value="">--- 所有科目 ---</option>
                            {% for subject_value, subject_label in subjects %}
                                <option value="{{ subject_value }}" {% if selected_subject_filter|safe == subject_value|stringformat:"s" %}selected{% endif %}>
                                    {{ subject_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> 筛选
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo"></i> 重置筛选
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 批量操作区域 -->
    <div class="card filter-card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-tasks me-2"></i>批量操作
            </h5>
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        <label class="form-check-label fw-bold" for="selectAll">
                            全选/取消全选
                        </label>
                        <span id="selectedCount" class="ms-3 text-muted">已选择: 0 条记录</span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button type="button" onclick="exportSelected()" class="btn btn-success me-2">
                        <i class="fas fa-download"></i> 导出选中项
                    </button>
                    <button type="button" onclick="deleteSelected()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> 删除选中项
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    {% if aggregated_scores %}
    <div class="table-container">
        <form id="batchForm" method="post">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input class="form-check-input" type="checkbox" id="headerCheckbox" onchange="toggleSelectAll()">
                            </th>
                            <th>学号</th>
                            <th>学生姓名</th>
                            <th>年级</th>
                            <th>班级</th>
                            <th>考试名称</th>
                            {# 動態生成科目列頭 #}
                            {% for subject_name in all_subjects %}
                                <th>{{ subject_name }}</th>
                            {% endfor %}
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row_data in aggregated_scores %}
                        <tr>
                            <td>
                                <input class="form-check-input record-checkbox" type="checkbox" name="selected_records" 
                                       value="{{ row_data.student_obj.pk }}_{{ row_data.exam_obj.pk }}" 
                                       onchange="updateSelectedCount()">
                            </td>
                            <td>{{ row_data.student_obj.student_id }}</td>
                            <td>{{ row_data.student_obj.name }}</td>
                            <td>{{ row_data.student_obj.get_grade_level_display }}</td>
                            <td>{{ row_data.class_obj.class_name|default:"N/A" }}</td>
                            <td>{{ row_data.exam_obj.name }}</td>
                            {# 遍歷所有科目，顯示對應分數 #}
                            {% for subject_name in all_subjects %}
                                <td>
                                    {% if row_data.scores|get_item:subject_name is not None %}
                                        <span class="badge bg-primary">{{ row_data.scores|get_item:subject_name }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            {% endfor %}
                            <td>
                                <a href="{% url 'score_batch_edit' %}?student={{ row_data.student_obj.pk }}&exam={{ row_data.exam_obj.pk }}" 
                                   class="btn btn-sm btn-warning">
                                    <i class="fas fa-edit"></i> 编辑成绩
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle"></i> 目前没有任何成绩记录。
        </div>
    {% endif %}
    
    <!-- 分页导航 -->
    {% if is_paginated %}
    <nav aria-label="成绩列表分页">
        <ul class="pagination justify-content-center mt-4">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if request.GET.student_id_filter %}&student_id_filter={{ request.GET.student_id_filter }}{% endif %}{% if request.GET.student_name_filter %}&student_name_filter={{ request.GET.student_name_filter }}{% endif %}{% if request.GET.exam_filter %}&exam_filter={{ request.GET.exam_filter }}{% endif %}{% if request.GET.subject_filter %}&subject_filter={{ request.GET.subject_filter }}{% endif %}{% if request.GET.grade_filter %}&grade_filter={{ request.GET.grade_filter }}{% endif %}{% if request.GET.class_filter %}&class_filter={{ request.GET.class_filter }}{% endif %}" aria-label="首页">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.student_id_filter %}&student_id_filter={{ request.GET.student_id_filter }}{% endif %}{% if request.GET.student_name_filter %}&student_name_filter={{ request.GET.student_name_filter }}{% endif %}{% if request.GET.exam_filter %}&exam_filter={{ request.GET.exam_filter }}{% endif %}{% if request.GET.subject_filter %}&subject_filter={{ request.GET.subject_filter }}{% endif %}{% if request.GET.grade_filter %}&grade_filter={{ request.GET.grade_filter }}{% endif %}{% if request.GET.class_filter %}&class_filter={{ request.GET.class_filter }}{% endif %}" aria-label="上一页">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.student_id_filter %}&student_id_filter={{ request.GET.student_id_filter }}{% endif %}{% if request.GET.student_name_filter %}&student_name_filter={{ request.GET.student_name_filter }}{% endif %}{% if request.GET.exam_filter %}&exam_filter={{ request.GET.exam_filter }}{% endif %}{% if request.GET.subject_filter %}&subject_filter={{ request.GET.subject_filter }}{% endif %}{% if request.GET.grade_filter %}&grade_filter={{ request.GET.grade_filter }}{% endif %}{% if request.GET.class_filter %}&class_filter={{ request.GET.class_filter }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.student_id_filter %}&student_id_filter={{ request.GET.student_id_filter }}{% endif %}{% if request.GET.student_name_filter %}&student_name_filter={{ request.GET.student_name_filter }}{% endif %}{% if request.GET.exam_filter %}&exam_filter={{ request.GET.exam_filter }}{% endif %}{% if request.GET.subject_filter %}&subject_filter={{ request.GET.subject_filter }}{% endif %}{% if request.GET.grade_filter %}&grade_filter={{ request.GET.grade_filter }}{% endif %}{% if request.GET.class_filter %}&class_filter={{ request.GET.class_filter }}{% endif %}" aria-label="下一页">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.student_id_filter %}&student_id_filter={{ request.GET.student_id_filter }}{% endif %}{% if request.GET.student_name_filter %}&student_name_filter={{ request.GET.student_name_filter }}{% endif %}{% if request.GET.exam_filter %}&exam_filter={{ request.GET.exam_filter }}{% endif %}{% if request.GET.subject_filter %}&subject_filter={{ request.GET.subject_filter }}{% endif %}{% if request.GET.grade_filter %}&grade_filter={{ request.GET.grade_filter }}{% endif %}{% if request.GET.class_filter %}&class_filter={{ request.GET.class_filter }}{% endif %}" aria-label="末页">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            {% endif %}
        </ul>
        
        <div class="text-center mt-2">
            <small class="text-muted">
                显示第 {{ page_obj.start_index }} - {{ page_obj.end_index }} 条记录，共 {{ page_obj.paginator.count }} 条
            </small>
        </div>
    </nav>
    {% endif %}
</div>

<!-- 批量导入模态窗口 -->
<div class="modal fade" id="batchImportModal" tabindex="-1" aria-labelledby="batchImportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchImportModalLabel">
                    <i class="fas fa-upload"></i> 批量导入成绩 (Excel)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="batchImportForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="exam" class="form-label">选择考试 <span class="text-danger">*</span></label>
                            <select class="form-select" id="exam" name="exam" required>
                                <option value="">--- 请选择考试 ---</option>
                                {% for exam in exams %}
                                    <option value="{{ exam.pk }}">
                                        {{ exam.academic_year }} {{ exam.name }} ({{ exam.get_grade_level_display }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="excel_file" class="form-label">选择Excel文件 <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="excel_file" name="excel_file" accept=".xlsx,.xls" required>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>使用说明：</strong>
                                <ul class="mb-0 mt-2">
                                    <li>请确保Excel文件格式正确，第一行为标题行</li>
                                    <li>必须包含"学号"和"学生姓名"列</li>
                                    <li>科目列名必须与系统中的科目名称完全一致</li>
                                    <li><a href="{% url 'download_score_import_template' %}" target="_blank" class="text-decoration-none">
                                        <i class="fas fa-download"></i> 下载模板文件
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-success" id="uploadBtn">
                    <i class="fas fa-upload"></i> 开始上传
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批量导入结果模态框 -->
<div class="modal fade" id="importResultModal" tabindex="-1" aria-labelledby="importResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importResultModalLabel">
                    <i class="fas fa-info-circle"></i> 导入结果
                </h5>
            </div>
            <div class="modal-body">
                <div id="importResultContent">
                    <!-- 动态内容将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> 关闭
                </button>
                <button type="button" class="btn btn-info" id="viewDetailsBtn" style="display: none;">
                    <i class="fas fa-list"></i> 查看上传详情
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批量删除确认模态窗口 -->
<div class="modal fade" id="batchDeleteConfirmModal" tabindex="-1" aria-labelledby="batchDeleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchDeleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-danger"></i>确认批量删除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                    <div>
                        <h6 class="alert-heading mb-1">危险操作警告</h6>
                        <p class="mb-0" id="batchDeleteConfirmMessage"><!-- 动态内容 --></p>
                        <small class="text-muted">此操作不可逆，请谨慎操作！</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" id="confirmBatchDeleteBtn" onclick="confirmBatchDelete()">
                    <i class="fas fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 无选择警告模态窗口 -->
<div class="modal fade" id="noSelectionWarningModal" tabindex="-1" aria-labelledby="noSelectionWarningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noSelectionWarningModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>操作提示
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                    <div>
                        <h6 class="alert-heading mb-1">操作提示</h6>
                        <p class="mb-0" id="warningMessage"><!-- 动态内容 --></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-1"></i>我知道了
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript功能 -->
<script>
    // 缓存DOM元素，避免重复查询
    let cachedElements = null;
    
    function getCachedElements() {
        if (!cachedElements) {
            cachedElements = {
                selectAllCheckbox: document.getElementById('selectAll'),
                headerCheckbox: document.getElementById('headerCheckbox'),
                selectedCount: document.getElementById('selectedCount'),
                recordCheckboxes: document.querySelectorAll('.record-checkbox')
            };
        }
        return cachedElements;
    }
    
    function toggleSelectAll() {
        const elements = getCachedElements();
        
        // 同步全选复选框状态
        if (elements.selectAllCheckbox && elements.headerCheckbox && 
            elements.selectAllCheckbox.checked !== elements.headerCheckbox.checked) {
            elements.headerCheckbox.checked = elements.selectAllCheckbox.checked;
        }
        
        // 设置所有记录复选框状态
        const isChecked = (elements.selectAllCheckbox && elements.selectAllCheckbox.checked) || 
                         (elements.headerCheckbox && elements.headerCheckbox.checked);
        if (elements.recordCheckboxes) {
            elements.recordCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        }
        
        updateSelectedCount();
    }
    
    function updateSelectedCount() {
        const elements = getCachedElements();
        const checkedCount = Array.from(elements.recordCheckboxes).filter(cb => cb.checked).length;
        const totalCount = elements.recordCheckboxes.length;
        
        // 更新选中数量显示
        if (elements.selectedCount) {
            elements.selectedCount.textContent = `已选择: ${checkedCount} 条记录`;
        }
        
        // 更新全选复选框状态
        if (checkedCount === 0) {
            if (elements.selectAllCheckbox) {
                elements.selectAllCheckbox.indeterminate = false;
                elements.selectAllCheckbox.checked = false;
            }
            if (elements.headerCheckbox) {
                elements.headerCheckbox.indeterminate = false;
                elements.headerCheckbox.checked = false;
            }
        } else if (checkedCount === totalCount) {
            if (elements.selectAllCheckbox) {
                elements.selectAllCheckbox.indeterminate = false;
                elements.selectAllCheckbox.checked = true;
            }
            if (elements.headerCheckbox) {
                elements.headerCheckbox.indeterminate = false;
                elements.headerCheckbox.checked = true;
            }
        } else {
            if (elements.selectAllCheckbox) {
                elements.selectAllCheckbox.indeterminate = true;
                elements.selectAllCheckbox.checked = false;
            }
            if (elements.headerCheckbox) {
                elements.headerCheckbox.indeterminate = true;
                elements.headerCheckbox.checked = false;
            }
        }
    }
    
    function exportSelected() {
        const elements = getCachedElements();
        const checkedBoxes = Array.from(elements.recordCheckboxes).filter(cb => cb.checked);
        if (checkedBoxes.length === 0) {
            // 显示警告模态窗口
            const modal = new bootstrap.Modal(document.getElementById('noSelectionWarningModal'));
            document.getElementById('warningMessage').textContent = '请先选择要导出的记录';
            modal.show();
            return;
        }
        
        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "score_batch_export_selected" %}';
        
        // 添加CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // 添加选中的记录
        checkedBoxes.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_records';
            input.value = checkbox.value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }
    
    function deleteSelected() {
        const elements = getCachedElements();
        const checkedBoxes = Array.from(elements.recordCheckboxes).filter(cb => cb.checked);
        if (checkedBoxes.length === 0) {
            // 显示警告模态窗口
            const modal = new bootstrap.Modal(document.getElementById('noSelectionWarningModal'));
            document.getElementById('warningMessage').textContent = '请先选择要删除的记录';
            modal.show();
            return;
        }
        
        // 显示删除确认模态窗口
        const confirmMessage = document.getElementById('batchDeleteConfirmMessage');
        confirmMessage.textContent = `您即将删除选中的 ${checkedBoxes.length} 条成绩记录。`;
        
        const modal = new bootstrap.Modal(document.getElementById('batchDeleteConfirmModal'));
        modal.show();
        
        // 存储选中的复选框以供确认时使用
        window.selectedCheckboxes = checkedBoxes;
    }
    
    function confirmBatchDelete() {
        const checkedBoxes = window.selectedCheckboxes;
        if (!checkedBoxes || checkedBoxes.length === 0) {
            return;
        }
        
        // 创建表单并提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "score_batch_delete_selected" %}';
        
        // 添加CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // 添加选中的记录
        checkedBoxes.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_records';
            input.value = checkbox.value;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
        
        // 关闭模态窗口
        const modal = bootstrap.Modal.getInstance(document.getElementById('batchDeleteConfirmModal'));
        modal.hide();
    }
    
    // Toast通知功能
    function showToast(message, type = 'info') {
        // 创建toast容器（如果不存在）
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '9999';
            document.body.appendChild(toastContainer);
        }
        
        // 创建toast元素
        const toastId = 'toast_' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <i class="fas fa-${type === 'success' ? 'check-circle text-success' : type === 'error' ? 'exclamation-circle text-danger' : type === 'warning' ? 'exclamation-triangle text-warning' : 'info-circle text-info'}"></i>
                    <strong class="me-auto ms-2">${type === 'success' ? '成功' : type === 'error' ? '错误' : type === 'warning' ? '警告' : '信息'}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        // 显示toast
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: type === 'error' ? 5000 : 3000
        });
        toast.show();
        
        // 自动移除toast元素
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }
    
    // 显示导入结果模态框
    function showImportResult(data) {
        const resultContent = document.getElementById('importResultContent');
        const viewDetailsBtn = document.getElementById('viewDetailsBtn');
        
        let content = '';
        
        if (data.success) {
            content = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle"></i> 导入成功！</h5>
                    <p>成功导入 <strong>${data.imported_count}</strong> 个学生</p>
                    ${data.failed_count > 0 ? `<p>失败 <strong>${data.failed_count}</strong> 个学生</p>` : ''}
                </div>
            `;
        } else {
            content = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-circle"></i> 导入失败！</h5>
                    <p>${data.message}</p>
                    ${data.failed_count > 0 ? `<p>失败 <strong>${data.failed_count}</strong> 个学生</p>` : ''}
                </div>
            `;
        }
        
        resultContent.innerHTML = content;
        
        // 如果有错误详情，显示查看详情按钮
        if (data.error_details && data.error_details.length > 0) {
            viewDetailsBtn.style.display = 'inline-block';
            viewDetailsBtn.onclick = () => showErrorDetails(data.error_details);
        } else {
            viewDetailsBtn.style.display = 'none';
        }
        
        // 显示结果模态框
        const resultModal = new bootstrap.Modal(document.getElementById('importResultModal'));
        resultModal.show();
        
        // 如果导入成功，在模态框关闭后刷新页面
        if (data.success && data.imported_count > 0) {
            document.getElementById('importResultModal').addEventListener('hidden.bs.modal', function() {
                window.location.reload();
            }, { once: true });
        }
    }
    
    // 显示错误详情
    function showErrorDetails(errorDetails) {
        const resultContent = document.getElementById('importResultContent');
        
        let detailsHtml = `
            <div class="alert alert-warning">
                <h5><i class="fas fa-exclamation-triangle"></i> 上传详情</h5>
                <p>以下是导入失败的记录详情：</p>
            </div>
            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>行号</th>
                            <th>学号</th>
                            <th>学生姓名</th>
                            <th>失败原因</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        errorDetails.forEach(error => {
            detailsHtml += `
                <tr>
                    <td>${error.row}</td>
                    <td>${error.student_id || '-'}</td>
                    <td>${error.student_name || '-'}</td>
                    <td>
                        <ul class="mb-0">
                            ${error.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </td>
                </tr>
            `;
        });
        
        detailsHtml += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-secondary" onclick="showImportSummary()">
                    <i class="fas fa-arrow-left"></i> 返回摘要
                </button>
            </div>
        `;
        
        resultContent.innerHTML = detailsHtml;
    }
    
    // 显示导入摘要（从详情返回）
    function showImportSummary() {
        // 这里需要重新获取原始数据，简化处理，直接关闭模态框
        const resultModal = bootstrap.Modal.getInstance(document.getElementById('importResultModal'));
        resultModal.hide();
    }
    
    // 批量导入功能
    function handleBatchImport() {
        // 获取表单元素
        const form = document.getElementById('batchImportForm');
        const examSelect = document.getElementById('exam');
        const fileInput = document.getElementById('excel_file');
        const uploadBtn = document.getElementById('uploadBtn');
        
        // 验证表单
        if (!examSelect.value) {
            showToast('请选择考试', 'warning');
            return;
        }
        
        if (!fileInput.files.length) {
            showToast('请选择Excel文件', 'warning');
            return;
        }
        
        // 验证文件类型
        const file = fileInput.files[0];
        const allowedTypes = ['.xlsx', '.xls'];
        const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExtension)) {
            showToast('请选择有效的Excel文件（.xlsx或.xls）', 'error');
            return;
        }
        
        // 显示上传进度
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上传中...';
        uploadBtn.disabled = true;
        
        // 创建FormData
        const formData = new FormData(form);
        
        // 获取CSRF token
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        
        if (!csrfTokenElement) {
            showToast('CSRF token未找到，请刷新页面重试', 'error');
            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 开始上传';
            uploadBtn.disabled = false;
            return;
        }
        
        const csrfToken = csrfTokenElement.value;
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // 发送AJAX请求
        fetch('{% url "score_batch_import_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            // 关闭批量导入模态窗口
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchImportModal'));
            modal.hide();
            
            // 重置表单
            form.reset();
            
            // 显示结果模态框
            showImportResult(data);
        })
        .catch(error => {
            console.error('Error:', error);
            
            // 关闭批量导入模态窗口
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchImportModal'));
            modal.hide();
            
            // 重置表单
            form.reset();
            
            // 显示错误结果
            showImportResult({
                success: false,
                message: '网络错误，请稍后重试',
                imported_count: 0,
                failed_count: 0,
                error_details: []
            });
        })
        .finally(() => {
            // 恢复按钮状态
            uploadBtn.innerHTML = '<i class="fas fa-upload"></i> 开始上传';
            uploadBtn.disabled = false;
        });
    }
    
    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 使用事件委托绑定复选框事件，提升性能
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('record-checkbox')) {
                updateSelectedCount();
            }
        });
        
        updateSelectedCount();
        
        // 绑定批量导入按钮事件
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
            uploadBtn.addEventListener('click', handleBatchImport);
        }
        
        // 模态窗口重置事件
        const batchImportModal = document.getElementById('batchImportModal');
        if (batchImportModal) {
            batchImportModal.addEventListener('hidden.bs.modal', function() {
                document.getElementById('batchImportForm').reset();
            });
        }
    });
    
    function resetFilters() {
    // 重置所有筛选表单字段
    document.querySelector('form').reset();
    // 或者直接跳转到清空筛选的页面
    window.location.href = '{% url "score_list" %}';
    }
</script>
{% endblock %}