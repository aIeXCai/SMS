{% extends 'base.html' %}

{% block title %}系统首页{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
    }

    .stat-card {
        border: none;
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-icon-bg {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        font-size: 24px;
    }

    .bg-teal-light {
        background-color: #e8f5f3;
        color: #01876c;
    }

    .bg-blue-light {
        background-color: #e3f2fd;
        color: #1976d2;
    }

    .bg-orange-light {
        background-color: #fff3e0;
        color: #f57c00;
    }

    .bg-purple-light {
        background-color: #f3e5f5;
        color: #7b1fa2;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #333;
    }

    .stat-label {
        color: #666;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .welcome-card {
        background: linear-gradient(135deg, #01876c 0%, #00695c 100%);
        color: white;
        border: none;
    }

    .welcome-card .text-muted {
        color: rgba(255, 255, 255, 0.8) !important;
    }

    .quick-action-btn {
        border: 1px solid #e0e0e0;
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        color: #555;
    }

    .quick-action-btn:hover {
        border-color: #01876c;
        background: #f0f9f8;
        color: #01876c;
        transform: translateY(-2px);
    }

    .quick-action-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #01876c;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        padding-left: 10px;
        border-left: 4px solid #01876c;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- 顶部欢迎栏 -->
    <div class="dashboard-header d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-1 fw-bold text-dark">系统首页</h4>
            <p class="text-muted mb-0">今天是 <span id="current-date"></span>，祝您工作愉快！</p>
        </div>
        <div class="text-end d-none d-md-block">
            <div class="d-flex align-items-center bg-light rounded-pill px-3 py-2">
                <i class="far fa-clock me-2 text-primary"></i>
                <span id="current-time" class="fw-bold text-dark"></span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- 左侧主要内容 -->
        <div class="col-lg-8">
            <!-- 统计卡片 -->
            <div class="row g-4 mb-4">
                <div class="col-md-6 col-xl-3">
                    <div class="card stat-card">
                        <div class="card-body text-center p-4">
                            <div class="stat-icon-bg bg-teal-light mx-auto">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="stat-value" id="stat-student-count">...</div>
                            <div class="stat-label">学生总数</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="card stat-card">
                        <div class="card-body text-center p-4">
                            <div class="stat-icon-bg bg-blue-light mx-auto">
                                <i class="fas fa-chalkboard"></i>
                            </div>
                            <div class="stat-value" id="stat-class-count">...</div>
                            <div class="stat-label">班级数量</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="card stat-card">
                        <div class="card-body text-center p-4">
                            <div class="stat-icon-bg bg-orange-light mx-auto">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="stat-value" id="stat-exam-count">...</div>
                            <div class="stat-label">本月考试</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="card stat-card">
                        <div class="card-body text-center p-4">
                            <div class="stat-icon-bg bg-purple-light mx-auto">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="stat-value" id="stat-score-count">...</div>
                            <div class="stat-label">成绩记录</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 快捷操作 -->
            <div class="mb-4">
                <h5 class="section-title">快捷操作</h5>
                <div class="row g-3">
                    <div class="col-6 col-md-3">
                        <a href="{% url 'students_grades:student_list' %}" class="quick-action-btn">
                            <i class="fas fa-users quick-action-icon"></i>
                            <span>学生管理</span>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'students_grades:exam_list' %}" class="quick-action-btn">
                            <i class="fas fa-clipboard-list quick-action-icon"></i>
                            <span>考试管理</span>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'students_grades:score_list' %}" class="quick-action-btn">
                            <i class="fas fa-edit quick-action-icon"></i>
                            <span>成绩录入</span>
                        </a>
                    </div>
                    <div class="col-6 col-md-3">
                        <a href="{% url 'students_grades:score_query' %}" class="quick-action-btn">
                            <i class="fas fa-search quick-action-icon"></i>
                            <span>成绩查询</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- 最近活动/系统公告 (占位) -->
            <div class="card border-0 shadow-sm rounded-3">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <h5 class="mb-0 fw-bold"><i class="fas fa-bell me-2 text-warning"></i>系统公告</h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="alert alert-info border-0 bg-blue-light text-dark mb-0">
                        <i class="fas fa-info-circle me-2 text-primary"></i>
                        欢迎使用新版学校管理系统！系统已全面升级，整合了学生档案与成绩管理功能。
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧侧边栏 -->
        <div class="col-lg-4">
            <!-- 用户信息卡片 -->
            <div class="card welcome-card mb-4 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <div class="bg-white rounded-circle p-1 me-3">
                            {% if user.profile.avatar_url %}
                            <img src="{{ user.profile.avatar_url }}" alt="Avatar" class="rounded-circle" width="50"
                                height="50">
                            {% else %}
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                                style="width: 50px; height: 50px;">
                                <i class="fas fa-user text-secondary fs-4"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div>
                            <h5 class="mb-0 fw-bold">{{ user.get_full_name|default:user.username }}</h5>
                            <small class="text-white-50">{{ user.get_role_display|default:"管理员" }}</small>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 bg-white bg-opacity-10 rounded">
                                <small class="d-block text-white-50">上次登录</small>
                                <span class="fw-bold">{{ user.last_login|date:"m-d H:i"|default:"首次登录" }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-white bg-opacity-10 rounded">
                                <small class="d-block text-white-50">负责年级</small>
                                <span class="fw-bold">{{ user.managed_grade|default:"全校" }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 系统状态 -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                    <h5 class="mb-0 fw-bold">系统状态</h5>
                </div>
                <div class="card-body px-4">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-server text-success fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">服务运行正常</h6>
                            <small class="text-muted">所有服务节点在线</small>
                        </div>
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-database text-primary fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">数据库连接正常</h6>
                            <small class="text-muted">延迟: 12ms</small>
                        </div>
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-tasks text-info fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">异步任务队列</h6>
                            <small class="text-muted">运行中</small>
                        </div>
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 更新时间显示
    function updateTime() {
        const now = new Date();
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };

        document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', dateOptions);
        document.getElementById('current-time').textContent = now.toLocaleTimeString('zh-CN', timeOptions);
    }

    // 获取统计数据
    function fetchDashboardStats() {
        fetch('/api/dashboard/stats/')
            .then(response => response.json())
            .then(data => {
                // 使用简单的动画效果更新数字
                animateValue("stat-student-count", parseInt(document.getElementById("stat-student-count").innerText) || 0, data.student_count, 1000);
                animateValue("stat-class-count", parseInt(document.getElementById("stat-class-count").innerText) || 0, data.class_count, 1000);
                animateValue("stat-exam-count", parseInt(document.getElementById("stat-exam-count").innerText) || 0, data.exam_count, 1000);
                animateValue("stat-score-count", parseInt(document.getElementById("stat-score-count").innerText) || 0, data.score_count, 1000);
            })
            .catch(error => {
                console.error('Error fetching stats:', error);
            });
    }

    // 数字滚动动画
    function animateValue(id, start, end, duration) {
        if (start === end) return;
        // 如果是初始加载（start是NaN或...），从0开始
        if (isNaN(start)) start = 0;

        const obj = document.getElementById(id);
        const range = end - start;
        const minTimer = 50;
        let stepTime = Math.abs(Math.floor(duration / range));
        stepTime = Math.max(stepTime, minTimer);

        const startTime = new Date().getTime();
        const endTime = startTime + duration;
        let timer;

        function run() {
            const now = new Date().getTime();
            const remaining = Math.max((endTime - now) / duration, 0);
            const value = Math.round(end - (remaining * range));
            obj.innerHTML = value.toLocaleString();
            if (value == end) {
                clearInterval(timer);
            }
        }

        timer = setInterval(run, stepTime);
        run();
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        updateTime();
        setInterval(updateTime, 1000);

        fetchDashboardStats();
        // 每30秒更新一次数据
        setInterval(fetchDashboardStats, 30000);
    });
</script>
{% endblock %}